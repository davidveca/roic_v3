// ROIC V3 SaaS - Complete Data Model
// Multi-tenant, versioned, audit-ready initiative modeling workspace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// MULTI-TENANT CORE
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}") // TUFI definition, tax rate defaults, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  initiatives Initiative[]
  driverDefs  DriverDefinition[]
  templates   InitiativeTemplate[]
  auditEvents AuditEvent[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  passwordHash  String? // For credentials provider
  orgId         String?
  orgRole       OrgRole   @default(VIEWER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  org                  Organization?        @relation(fields: [orgId], references: [id])
  accounts             Account[]
  sessions             Session[]
  ownedInitiatives     Initiative[]
  initiativeRoles      InitiativeUserRole[]
  createdVersions      InitiativeVersion[]  @relation("CreatedBy")
  lockedVersions       InitiativeVersion[]  @relation("LockedBy")
  driverValuesEntered  DriverValue[]
  auditEvents          AuditEvent[]
  comments             Comment[]
  inputRequestsSent    InputRequest[]       @relation("Requester")
  inputRequestsReceived InputRequest[]      @relation("Assignee")
}

enum OrgRole {
  ADMIN
  FINANCE
  EDITOR
  CONTRIBUTOR
  VIEWER
}

// ============================================================================
// NEXTAUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// INITIATIVE & VERSIONING
// ============================================================================

model Initiative {
  id         String           @id @default(cuid())
  orgId      String
  title      String
  description String?
  templateId String?
  ownerId    String
  status     InitiativeStatus @default(DRAFT)
  tags       Json             @default("[]") // BU, site, function, customer tier, product family
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  org       Organization        @relation(fields: [orgId], references: [id])
  owner     User                @relation(fields: [ownerId], references: [id])
  template  InitiativeTemplate? @relation(fields: [templateId], references: [id])
  versions  InitiativeVersion[]
  userRoles InitiativeUserRole[]
}

enum InitiativeStatus {
  IDEA
  DRAFT
  IN_REVIEW
  APPROVED
  IN_FLIGHT
  REALIZED
  ARCHIVED
}

model InitiativeVersion {
  id           String       @id @default(cuid())
  initiativeId String
  versionLabel String       // v0.1, v1.0, etc.
  state        VersionState @default(DRAFT)
  createdById  String
  lockedAt     DateTime?
  lockedById   String?
  notes        String?      // Version notes/changelog
  createdAt    DateTime     @default(now())

  initiative    Initiative     @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  createdBy     User           @relation("CreatedBy", fields: [createdById], references: [id])
  lockedBy      User?          @relation("LockedBy", fields: [lockedById], references: [id])
  driverValues  DriverValue[]
  scenarios     Scenario[]
  inputRequests InputRequest[]
  comments      Comment[]

  @@unique([initiativeId, versionLabel])
}

enum VersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  SUPERSEDED
}

model InitiativeUserRole {
  id           String         @id @default(cuid())
  initiativeId String
  userId       String
  role         InitiativeRole
  createdAt    DateTime       @default(now())

  initiative Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([initiativeId, userId])
}

enum InitiativeRole {
  OWNER
  CONTRIBUTOR
  REVIEWER
  VIEWER
}

// ============================================================================
// DRIVER LIBRARY & VALUES
// ============================================================================

model DriverDefinition {
  id           String         @id @default(cuid())
  orgId        String?        // null = global/system driver
  key          String         // unique identifier like "freight_savings_pct"
  name         String
  description  String?
  helpText     String?        // "explain like I'm in ops"
  units        String         // %, $, units, days
  dataType     DriverDataType
  validation   Json?          // { min, max, required, step, options, etc. }
  defaultValue Json?
  category     String         // revenue, cost, working_capital, capex, risk
  sortOrder    Int            @default(0)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  org Organization? @relation(fields: [orgId], references: [id])

  @@unique([orgId, key])
  @@index([category])
}

enum DriverDataType {
  NUMBER
  PERCENTAGE
  CURRENCY
  INTEGER
  DATE
  SELECT
  BOOLEAN
  CURVE      // for ramp curves (array of period values)
  TEXT
}

model DriverValue {
  id          String      @id @default(cuid())
  versionId   String
  driverKey   String
  value       Json        // flexible: number, string, array for curves
  source      ValueSource @default(MANUAL)
  enteredById String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  version   InitiativeVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  enteredBy User?             @relation(fields: [enteredById], references: [id])

  @@unique([versionId, driverKey])
}

enum ValueSource {
  MANUAL
  IMPORTED
  REQUESTED
  CALCULATED
  BASELINE
}

// ============================================================================
// SCENARIOS & CALCULATIONS
// ============================================================================

model Scenario {
  id         String   @id @default(cuid())
  versionId  String
  name       String
  isBaseline Boolean  @default(false)
  overrides  Json     @default("{}") // driver key -> override value
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  version InitiativeVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)
  results CalculationResult[]

  @@unique([versionId, name])
}

model CalculationResult {
  id          String   @id @default(cuid())
  scenarioId  String
  period      Int      // year 1, 2, 3... (0 = summary/total)
  metrics     Json     // { nopat, tufi, roic, payback, irr, revenueImpact, costImpact, etc. }
  computeHash String   // hash of inputs for reproducibility
  computedAt  DateTime @default(now())

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, period])
  @@index([computeHash])
}

// ============================================================================
// INPUT REQUESTS (SECURE TOKEN PATTERN)
// ============================================================================

model InputRequest {
  id            String        @id @default(cuid())
  versionId     String
  requesterId   String
  assigneeEmail String
  assigneeId    String?
  driverKeys    String[]      // which drivers they can fill
  dueDate       DateTime?
  status        RequestStatus @default(PENDING)
  message       String?       // optional message from requester
  createdAt     DateTime      @default(now())
  completedAt   DateTime?

  version   InitiativeVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)
  requester User                @relation("Requester", fields: [requesterId], references: [id])
  assignee  User?               @relation("Assignee", fields: [assigneeId], references: [id])
  tokens    InputRequestToken[]
}

enum RequestStatus {
  PENDING
  VIEWED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

model InputRequestToken {
  id        String    @id @default(cuid())
  requestId String
  tokenHash String    @unique // store only hash, not the actual token
  expiresAt DateTime
  usedAt    DateTime?
  scope     Json      // { driverKeys: [...], permissions: [...] }
  createdAt DateTime  @default(now())

  request InputRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

// ============================================================================
// TEMPLATES
// ============================================================================

model InitiativeTemplate {
  id              String   @id @default(cuid())
  orgId           String?  // null = system template
  name            String   // "Freight Optimization", "Price/Mix", etc.
  description     String?
  category        String?  // revenue, cost, working_capital, etc.
  requiredDrivers String[] // driver keys that must be filled
  optionalDrivers String[] // driver keys that are optional
  defaultDrivers  Json     @default("{}") // { driverKey: defaultValue }
  scenarioKnobs   String[] // which drivers appear as scenario sliders
  iconName        String?  // lucide icon name
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  org         Organization? @relation(fields: [orgId], references: [id])
  initiatives Initiative[]

  @@unique([orgId, name])
}

// ============================================================================
// COMMENTS & COLLABORATION
// ============================================================================

model Comment {
  id        String   @id @default(cuid())
  versionId String
  authorId  String
  parentId  String?  // for threading
  driverKey String?  // optional: tie to specific driver
  content   String
  isResolved Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  version InitiativeVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  author  User              @relation(fields: [authorId], references: [id])
  parent  Comment?          @relation("Replies", fields: [parentId], references: [id])
  replies Comment[]         @relation("Replies")
}

// ============================================================================
// AUDIT TRAIL
// ============================================================================

model AuditEvent {
  id           String   @id @default(cuid())
  orgId        String
  actorId      String?
  actorEmail   String   // preserve even if user deleted
  action       String   // DRIVER_UPDATED, VERSION_LOCKED, INITIATIVE_CREATED, etc.
  resourceType String   // Initiative, DriverValue, Scenario, etc.
  resourceId   String
  oldValue     Json?
  newValue     Json?
  metadata     Json?    // additional context
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  org   Organization @relation(fields: [orgId], references: [id])
  actor User?        @relation(fields: [actorId], references: [id])

  @@index([orgId, createdAt])
  @@index([resourceType, resourceId])
  @@index([actorId, createdAt])
  @@index([action])
}

// ============================================================================
// FILE ATTACHMENTS
// ============================================================================

model Attachment {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  storageKey   String   // S3/R2 key
  uploadedById String
  resourceType String   // Initiative, DriverValue, Comment, etc.
  resourceId   String
  createdAt    DateTime @default(now())

  @@index([resourceType, resourceId])
}
