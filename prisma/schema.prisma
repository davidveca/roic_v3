// ROIC V3 SaaS - Single-Tenant Data Model for Wahl Clipper Corporation
// Versioned, audit-ready initiative modeling workspace

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// SETTINGS (Singleton - replaces Organization)
// ============================================================================

model Settings {
  id                   String   @id @default("singleton")
  hurdleRate           Float    @default(12) // Default hurdle rate %
  taxRate              Float    @default(25) // Default tax rate %
  currency             String   @default("USD")
  companyName          String   @default("Wahl Clipper Corporation")
  fiscalYearStart      Int      @default(1) // Month (1 = January)
  boardReviewThreshold Float    @default(2000000) // >$2M = board review
  lightTouchThreshold  Float    @default(50000) // <$50K = light touch
  updatedAt            DateTime @updatedAt
}

// ============================================================================
// USER (Simplified - no org roles)
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts              Account[]
  sessions              Session[]
  ownedInitiatives      Initiative[]
  createdVersions       InitiativeVersion[] @relation("CreatedBy")
  lockedVersions        InitiativeVersion[] @relation("LockedBy")
  driverValuesEntered   DriverValue[]
  auditEvents           AuditEvent[]
  comments              Comment[]
  inputRequestsSent     InputRequest[]      @relation("Requester")
  inputRequestsReceived InputRequest[]      @relation("Assignee")
}

// ============================================================================
// NEXTAUTH.JS MODELS
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// INITIATIVE & VERSIONING
// ============================================================================

enum InitiativeType {
  COST_REDUCTION
  ACQUISITION
  NEW_PRODUCT
  CAPEX_PROJECT
  OTHER
}

enum InitiativeStatus {
  IDEA
  DRAFT
  IN_REVIEW
  APPROVED
  IN_FLIGHT
  REALIZED
  ARCHIVED
}

model Initiative {
  id                      String           @id @default(cuid())
  title                   String
  description             String?
  templateId              String?
  ownerId                 String
  ownerEmail              String // Denormalized for quick access checks
  collaboratorEmails      String? // Comma-separated emails
  isPublic                Boolean          @default(false)
  type                    InitiativeType   @default(OTHER)
  status                  InitiativeStatus @default(DRAFT)
  tags                    Json             @default("[]") // BU, site, function, etc.

  // Data warehouse integration
  externalId              String?          @unique // UUID for Snowflake/Fivetran sync
  syncedAt                DateTime?

  // Realization tracking (actuals vs modeled)
  actualsNopat            Decimal?         @db.Decimal(18, 2)
  actualsInvestedCapital  Decimal?         @db.Decimal(18, 2)

  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  owner    User                @relation(fields: [ownerId], references: [id])
  template InitiativeTemplate? @relation(fields: [templateId], references: [id])
  versions InitiativeVersion[]

  @@index([ownerEmail])
  @@index([isPublic])
  @@index([type])
}

model InitiativeVersion {
  id           String       @id @default(cuid())
  initiativeId String
  versionLabel String // v0.1, v1.0, etc.
  state        VersionState @default(DRAFT)
  createdById  String
  lockedAt     DateTime?
  lockedById   String?
  notes        String? // Version notes/changelog
  createdAt    DateTime     @default(now())

  initiative    Initiative     @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  createdBy     User           @relation("CreatedBy", fields: [createdById], references: [id])
  lockedBy      User?          @relation("LockedBy", fields: [lockedById], references: [id])
  driverValues  DriverValue[]
  scenarios     Scenario[]
  inputRequests InputRequest[]
  comments      Comment[]

  @@unique([initiativeId, versionLabel])
}

enum VersionState {
  DRAFT
  IN_REVIEW
  APPROVED
  SUPERSEDED
}

// ============================================================================
// DRIVER LIBRARY & VALUES
// ============================================================================

model DriverDefinition {
  id           String         @id @default(cuid())
  key          String         @unique // unique identifier like "freight_savings_pct"
  name         String
  description  String?
  helpText     String? // "explain like I'm in ops"
  units        String // %, $, units, days
  dataType     DriverDataType
  validation   Json? // { min, max, required, step, options, etc. }
  defaultValue Json?
  category     String // revenue, cost, working_capital, capex, risk
  sortOrder    Int            @default(0)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([category])
}

enum DriverDataType {
  NUMBER
  PERCENTAGE
  CURRENCY
  INTEGER
  DATE
  SELECT
  BOOLEAN
  CURVE // for ramp curves (array of period values)
  TEXT
}

model DriverValue {
  id          String      @id @default(cuid())
  versionId   String
  driverKey   String
  value       Json // flexible: number, string, array for curves
  source      ValueSource @default(MANUAL)
  enteredById String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  version   InitiativeVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  enteredBy User?             @relation(fields: [enteredById], references: [id])

  @@unique([versionId, driverKey])
}

enum ValueSource {
  MANUAL
  IMPORTED
  REQUESTED
  CALCULATED
  BASELINE
}

// ============================================================================
// SCENARIOS & CALCULATIONS
// ============================================================================

model Scenario {
  id         String   @id @default(cuid())
  versionId  String
  name       String
  isBaseline Boolean  @default(false)
  overrides  Json     @default("{}") // driver key -> override value
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  version InitiativeVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)
  results CalculationResult[]

  @@unique([versionId, name])
}

model CalculationResult {
  id          String   @id @default(cuid())
  scenarioId  String
  period      Int // year 1, 2, 3... (0 = summary/total)
  metrics     Json // { nopat, tufi, roic, payback, irr, revenueImpact, costImpact, etc. }
  computeHash String // hash of inputs for reproducibility
  computedAt  DateTime @default(now())

  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, period])
  @@index([computeHash])
}

// ============================================================================
// INPUT REQUESTS (SECURE TOKEN PATTERN)
// ============================================================================

model InputRequest {
  id            String        @id @default(cuid())
  versionId     String
  requesterId   String
  assigneeEmail String
  assigneeId    String?
  driverKeys    String[] // which drivers they can fill
  dueDate       DateTime?
  status        RequestStatus @default(PENDING)
  message       String? // optional message from requester
  createdAt     DateTime      @default(now())
  completedAt   DateTime?

  version   InitiativeVersion   @relation(fields: [versionId], references: [id], onDelete: Cascade)
  requester User                @relation("Requester", fields: [requesterId], references: [id])
  assignee  User?               @relation("Assignee", fields: [assigneeId], references: [id])
  tokens    InputRequestToken[]
}

enum RequestStatus {
  PENDING
  VIEWED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

model InputRequestToken {
  id        String    @id @default(cuid())
  requestId String
  tokenHash String    @unique // store only hash, not the actual token
  expiresAt DateTime
  usedAt    DateTime?
  scope     Json // { driverKeys: [...], permissions: [...] }
  createdAt DateTime  @default(now())

  request InputRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

// ============================================================================
// TEMPLATES
// ============================================================================

model InitiativeTemplate {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?
  category        String? // revenue, cost, working_capital, etc.
  requiredDrivers String[] // driver keys that must be filled
  optionalDrivers String[] // driver keys that are optional
  defaultDrivers  Json     @default("{}") // { driverKey: defaultValue }
  scenarioKnobs   String[] // which drivers appear as scenario sliders
  iconName        String? // lucide icon name
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  initiatives Initiative[]
}

// ============================================================================
// COMMENTS & COLLABORATION
// ============================================================================

model Comment {
  id         String   @id @default(cuid())
  versionId  String
  authorId   String
  parentId   String? // for threading
  driverKey  String? // optional: tie to specific driver
  content    String
  isResolved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  version InitiativeVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  author  User              @relation(fields: [authorId], references: [id])
  parent  Comment?          @relation("Replies", fields: [parentId], references: [id])
  replies Comment[]         @relation("Replies")
}

// ============================================================================
// AUDIT TRAIL
// ============================================================================

model AuditEvent {
  id           String   @id @default(cuid())
  actorId      String?
  actorEmail   String // preserve even if user deleted
  action       String // DRIVER_UPDATED, VERSION_LOCKED, INITIATIVE_CREATED, etc.
  resourceType String // Initiative, DriverValue, Scenario, etc.
  resourceId   String
  oldValue     Json?
  newValue     Json?
  metadata     Json? // additional context
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  actor User? @relation(fields: [actorId], references: [id])

  @@index([resourceType, resourceId])
  @@index([actorId, createdAt])
  @@index([action])
}

// ============================================================================
// FILE ATTACHMENTS
// ============================================================================

model Attachment {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  storageKey   String // S3/R2 key
  uploadedById String
  resourceType String // Initiative, DriverValue, Comment, etc.
  resourceId   String
  createdAt    DateTime @default(now())

  @@index([resourceType, resourceId])
}
